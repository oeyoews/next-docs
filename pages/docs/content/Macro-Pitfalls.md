---
title: '宏陷阱'
---

# 简介

在 TiddlyWiki 的早期，[宏](Macros)是封装片段以供重用的最佳方式，因此被广泛使用。然而，它们总是存在一些明显的缺点，这些缺点可能会导致错误和性能不佳。

<<.from-version "5.3.0">> [进程](Procedures)、[自定义小工具](Custom Widgets)和[函数](Functions)加入了宏，它们共同提供了更健壮和灵活的方式来封装和重用代码。现在建议仅在特别需要文本替换时才使用宏。

# 文本替换的缺点

TiddlyWiki 对[宏](Macros)参数的处理基于 "文本替换"，这意味着调用宏时，提供的参数的字符串值在被维基化之前，插入到宏定义中。

这是 TiddlyWiki 5 早期版本中该方法的典型示例。目的是提供一个宏，该宏采用条目标题的单个参数来查看：

```
\define mymacro(title)
<$codeblock code={{$title$}}/>
\end
```

这适用于像 `<<mymacro "HelloThere">>` 这样的简单情况，但有点脆弱。例如，上面的宏将因包含双右大括号的条目标题而失败。尝试将其与标题 `foo}}bar` 一起使用，会导致宏被扩充为以下无效语法：

```
<$codeblock code={{foo}}bar}}/>
```

由于这个问题，多年来，如果在条目标题中遇到特殊字符的各种组合，TiddlyWiki 5 用户界面就会失败。

多年来，这个问题已经得到缓解，特别是通过提供对宏参数当作变量的访问。但是，为了向后兼容，这样做是在不影响现有语法的情况下完成的，这要求我们采用笨拙的协议，将参数名称包裹在双下划线中，以获取相应变量的名称。

# 全局宏的性能

用 [SystemTag: $:/tags/Macro]] 定义的全局[[宏定义](Macro Definitions)性能不佳，因为无论是否实际使用每个宏都必须解析。

此外，导入定义的方式，意味着更新标签为 [SystemTag: $:/tags/Macro](#SystemTag%3A%20%24%3A/tags/Macro) 的条目，将导致整个页面被刷新。
